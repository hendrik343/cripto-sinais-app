<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Diagnóstico - CriptoSinais</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #0a0e17;
            color: #e0e0e0;
            padding-top: 20px;
        }
        .card {
            background-color: rgba(33, 37, 41, 0.85);
            border: 1px solid rgba(55, 85, 125, 0.2);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        .card-header {
            background-color: rgba(42, 48, 66, 0.8);
            border-bottom: 1px solid rgba(55, 85, 125, 0.2);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-healthy {
            background-color: #28a745;
            box-shadow: 0 0 8px #28a745;
        }
        .status-warning {
            background-color: #ffc107;
            box-shadow: 0 0 8px #ffc107;
        }
        .status-error {
            background-color: #dc3545;
            box-shadow: 0 0 8px #dc3545;
        }
        .dashboard-title {
            background: linear-gradient(90deg, #4a6bff, #2ddeff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            text-shadow: 0px 2px 3px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        .log-container {
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #1a1d21;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .log-info {
            color: #17a2b8;
        }
        .log-warning {
            color: #ffc107;
        }
        .log-error {
            color: #dc3545;
        }
        .api-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .api-up {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .api-limited {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .api-down {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .progress {
            height: 8px;
            margin-bottom: 10px;
            background-color: rgba(255,255,255,0.1);
        }
        .progress-bar-api {
            background-color: #17a2b8;
        }
        .progress-bar-db {
            background-color: #6f42c1;
        }
        .progress-bar-telegram {
            background-color: #0088cc;
        }
        .refresh-btn {
            background-color: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
            border: 1px solid rgba(23, 162, 184, 0.4);
            transition: all 0.3s;
            padding: 5px 10px;
        }
        .refresh-btn:hover {
            background-color: rgba(23, 162, 184, 0.4);
            color: white;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
        }
        .header-action {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center dashboard-title">
            <i class="fas fa-chart-line"></i> Painel de Diagnóstico em Tempo Real
        </h1>
        
        <div class="d-flex justify-content-between mb-4">
            <div>
                <h5><i class="fas fa-clock"></i> Última atualização: <span id="last-updated">{{ last_updated }}</span></h5>
            </div>
            <div>
                <button id="refresh-btn" class="btn refresh-btn">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Sistema em tempo real -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <span>
                            <span class="status-indicator {{ 'status-healthy' if system_status == 'healthy' else 'status-warning' if system_status == 'warning' else 'status-error' }}"></span>
                            Status do Sistema
                        </span>
                        <span class="header-action">
                            <button class="btn btn-sm refresh-btn" id="refresh-status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-4 text-center">
                                <div class="stat-value">{{ uptime_hours }}</div>
                                <div class="stat-label">Horas Online</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="stat-value">{{ total_alerts }}</div>
                                <div class="stat-label">Alertas Enviados</div>
                            </div>
                            <div class="col-4 text-center">
                                <div class="stat-value">{{ active_users }}</div>
                                <div class="stat-label">Usuários Ativos</div>
                            </div>
                        </div>
                        
                        <h6>Serviços:</h6>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>API CoinGecko:</span>
                                <span class="api-status {{ 'api-up' if api_coingecko_status == 'up' else 'api-limited' if api_coingecko_status == 'limited' else 'api-down' }}">
                                    {{ api_coingecko_status.upper() }}
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-api" role="progressbar" style="width: {{ api_health_percent }}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Banco de dados:</span>
                                <span class="api-status {{ 'api-up' if database_status == 'up' else 'api-limited' if database_status == 'degraded' else 'api-down' }}">
                                    {{ database_status.upper() }}
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-db" role="progressbar" style="width: {{ db_health_percent }}%"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span>API Telegram:</span>
                                <span class="api-status {{ 'api-up' if telegram_status == 'up' else 'api-limited' if telegram_status == 'limited' else 'api-down' }}">
                                    {{ telegram_status.upper() }}
                                </span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-telegram" role="progressbar" style="width: {{ telegram_health_percent }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alertas e Estatísticas -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <span>
                            <i class="fas fa-chart-bar"></i> Estatísticas de Moedas
                        </span>
                        <span class="header-action">
                            Últimas 24h
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Moeda</th>
                                        <th>Alertas</th>
                                        <th>Var. Máx</th>
                                        <th>Status API</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for coin in coin_stats %}
                                    <tr>
                                        <td>{{ coin.symbol }}</td>
                                        <td>{{ coin.alerts }}</td>
                                        <td class="{{ 'text-success' if coin.max_var > 0 else 'text-danger' }}">
                                            {{ coin.max_var }}%
                                        </td>
                                        <td>
                                            <span class="api-status {{ 'api-up' if coin.api_status == 'up' else 'api-limited' if coin.api_status == 'limited' else 'api-down' }}">
                                                {{ coin.api_status.upper() }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Logs do Sistema -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span>
                            <i class="fas fa-terminal"></i> Logs do Sistema
                        </span>
                        <span class="header-action">
                            <button class="btn btn-sm refresh-btn" id="refresh-logs">
                                <i class="fas fa-sync-alt"></i> Atualizar Logs
                            </button>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="log-container">
                            {% for log in system_logs %}
                            <div class="log-entry log-{{ log.level }}">
                                <span class="log-timestamp">{{ log.timestamp }}</span> 
                                <span class="log-level">[{{ log.level.upper() }}]</span> 
                                <span class="log-message">{{ log.message }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- API Rate Limits -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span>
                            <i class="fas fa-tachometer-alt"></i> Taxa de Requisições API
                        </span>
                        <span class="header-action">
                            Últimas 24h
                        </span>
                    </div>
                    <div class="card-body">
                        <canvas id="apiRateChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Database Performance -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <span>
                            <i class="fas fa-database"></i> Performance do Banco de Dados
                        </span>
                        <span class="header-action">
                            Últimas 24h
                        </span>
                    </div>
                    <div class="card-body">
                        <canvas id="dbPerformanceChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Setup API Rate Chart
        const apiRateCtx = document.getElementById('apiRateChart').getContext('2d');
        const apiRateChart = new Chart(apiRateCtx, {
            type: 'line',
            data: {
                labels: {{ api_rate_times | safe }},
                datasets: [{
                    label: 'Requisições / Minuto',
                    data: {{ api_rate_values | safe }},
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    }
                }
            }
        });
        
        // Setup DB Performance Chart
        const dbPerformanceCtx = document.getElementById('dbPerformanceChart').getContext('2d');
        const dbPerformanceChart = new Chart(dbPerformanceCtx, {
            type: 'line',
            data: {
                labels: {{ db_perf_times | safe }},
                datasets: [{
                    label: 'Tempo de Resposta (ms)',
                    data: {{ db_perf_values | safe }},
                    borderColor: '#6f42c1',
                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    }
                }
            }
        });
        
        // Auto-refresh logs
        function refreshLogs() {
            fetch('/api/system-logs')
                .then(response => response.json())
                .then(data => {
                    const logContainer = document.getElementById('log-container');
                    let logHtml = '';
                    data.forEach(log => {
                        logHtml += `<div class="log-entry log-${log.level}">
                                    <span class="log-timestamp">${log.timestamp}</span> 
                                    <span class="log-level">[${log.level.toUpperCase()}]</span> 
                                    <span class="log-message">${log.message}</span>
                                </div>`;
                    });
                    logContainer.innerHTML = logHtml;
                })
                .catch(error => console.error('Erro ao carregar logs:', error));
        }
        
        // Refresh system status
        function refreshSystemStatus() {
            fetch('/api/system-status')
                .then(response => response.json())
                .then(data => {
                    // Atualizar status indicators
                    const statusIndicator = document.querySelector('.status-indicator');
                    statusIndicator.className = 'status-indicator';
                    if (data.system_status === 'healthy') {
                        statusIndicator.classList.add('status-healthy');
                    } else if (data.system_status === 'warning') {
                        statusIndicator.classList.add('status-warning');
                    } else {
                        statusIndicator.classList.add('status-error');
                    }
                    
                    // Atualizar estatísticas
                    document.getElementById('last-updated').textContent = data.last_updated;
                    
                    // Atualizar APIs
                    const apiElements = document.querySelectorAll('.api-status');
                    apiElements[0].className = 'api-status';
                    if (data.api_coingecko_status === 'up') {
                        apiElements[0].classList.add('api-up');
                    } else if (data.api_coingecko_status === 'limited') {
                        apiElements[0].classList.add('api-limited');
                    } else {
                        apiElements[0].classList.add('api-down');
                    }
                    apiElements[0].textContent = data.api_coingecko_status.toUpperCase();
                    
                    // Atualizar barras de progresso
                    document.querySelector('.progress-bar-api').style.width = `${data.api_health_percent}%`;
                    document.querySelector('.progress-bar-db').style.width = `${data.db_health_percent}%`;
                    document.querySelector('.progress-bar-telegram').style.width = `${data.telegram_health_percent}%`;
                })
                .catch(error => console.error('Erro ao atualizar status:', error));
        }
        
        // Event Listeners
        document.getElementById('refresh-logs').addEventListener('click', refreshLogs);
        document.getElementById('refresh-status').addEventListener('click', refreshSystemStatus);
        document.getElementById('refresh-btn').addEventListener('click', function() {
            refreshLogs();
            refreshSystemStatus();
            window.location.reload();
        });
        
        // Auto-refresh a cada 60 segundos
        setInterval(refreshLogs, 60000);
        setInterval(refreshSystemStatus, 60000);
    </script>
</body>
</html>