name: Build Android APK

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display project structure
        run: |
          echo "Project structure:"
          ls -la
          find . -type d -maxdepth 2

      # Setup Java primeiro (necessário para o Android)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Setup Flutter mais recente
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      # Verificar versão do Flutter e Dart
      - name: Check Flutter version
        run: |
          flutter --version
          dart --version

      # Verificar estrutura inicial do projeto
      - name: Check flutter_app directory
        run: |
          echo "Flutter app directory content:"
          ls -la flutter_app
          echo "Android directory content (if exists):"
          ls -la flutter_app/android || echo "No android directory yet"
          
      # Criar pubspec.yaml se não existir
      - name: Ensure pubspec.yaml exists
        run: |
          cd flutter_app
          cat pubspec.yaml || echo "pubspec.yaml não encontrado"
          flutter doctor -v

      # Inicializar Flutter
      - name: Initialize Flutter
        run: |
          cd flutter_app
          flutter clean
          flutter pub get
          flutter create --org com.criptosinais --platforms=android --project-name criptosinais .

      # Verificar criação da estrutura Android
      - name: Verify Android files
        run: |
          echo "Android directory content after initialization:"
          ls -la flutter_app/android
          echo "Checking for gradlew:"
          find flutter_app -name gradlew
          echo "Android manifest:"
          cat flutter_app/android/app/src/main/AndroidManifest.xml || echo "Android manifest not found"

      # Configurar permissões do gradlew
      - name: Fix Gradle permissions
        run: |
          chmod +x flutter_app/android/gradlew
          flutter_app/android/gradlew -v

      # Tentar construir o APK
      - name: Build APK
        run: |
          cd flutter_app
          flutter pub get
          flutter build apk --debug --verbose

      # Verificar a saída
      - name: Check build output
        run: |
          echo "Checking build output:"
          find flutter_app/build -name "*.apk" | sort
          
      # Verificar o arquivo APK no diretório de saída
      - name: List APK files
        run: |
          ls -la flutter_app/build/app/outputs/flutter-apk/ || echo "APK directory not found"
          
      # Upload de APK de debug como alternativa
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: flutter_app/build/app/outputs/flutter-apk/app-debug.apk
          if-no-files-found: warn
          
      # Tentar upload do APK normal
      - name: Upload Release APK if exists
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: flutter_app/build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: warn